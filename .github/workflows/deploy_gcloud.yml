name: Deploy to Google Cloud

on: workflow_dispatch

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-18.04
    environment: dev
    env:
      APP_ID: decent-digit-629
      NODE_ENV: production
      DB_PORT: 3306
      GKE_ZONE: europe-west1-b
      MODULE_NAME: dev
      VERSION: ${{ github.run_number }}
      DATABASE_POSTFIX: ${{ secrets.DATABASE_POSTFIX }}
    steps:
      - name: "Checkout"
        uses: "actions/checkout@v2"

      - name: "Setup python"
        uses: actions/setup-python@v2
        with:
          python-version: "3.7.x"
          architecture: "x64"

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@master
        with:
          version: "331.0.0"
          service_account_key: ${{ secrets.GCLOUD_AUTH }}
          project_id: ${{ env.APP_ID }}

      - name: Deploy to Google Cloud
        uses: ./.github/actions/deploy_gcloud
